# 📁 批量上传文件到知识库使用指南

## 🚀 快速开始

### 1. 基本用法
```bash
# 上传指定文件夹中的所有文件
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source"

# 自定义知识库名称
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --kb-name "航天"
```

### 2. 高级用法
```bash
# 自定义AstrBot地址
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --astrbot-url "http://192.168.1.100:6185"

# 自定义登录信息
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --username "admin" --password "your_password"

# 设置分片参数
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --chunk-size 1000 --chunk-overlap 200

# 调整上传间隔
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --delay 2.0
```

## 📋 功能特点

### ✅ 智能去重
- 自动记录已上传文件
- 通过文件哈希值判断是否重复
- 避免重复上传相同文件

### ✅ 支持格式
- **文档**: PDF, DOC, DOCX, TXT, MD, RTF
- **表格**: XLS, XLSX, CSV
- **演示**: PPT, PPTX

### ✅ 自动管理
- 自动登录AstrBot
- 自动创建知识库
- 自动选择Embedding提供商

### ✅ 进度显示
- 实时显示上传进度
- 详细的统计信息
- 完整的日志记录

## 📊 上传记录

### 记录文件格式
脚本会创建 `upload_record.json` 文件记录上传历史：

```json
{
  "文件名.pdf": {
    "hash": "文件哈希值",
    "size": 文件大小,
    "collection_name": "知识库名称",
    "upload_time": "上传时间",
    "file_path": "文件路径"
  }
}
```

### 管理上传记录
```bash
# 使用自定义记录文件
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --record-file "my_upload_record.json"

# 清除记录重新上传
rm upload_record.json
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source"
```

## 🛠️ 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `folder_path` | 要上传的文件夹路径 | 必需 |
| `--kb-name` | 知识库名称 | "批量上传知识库" |
| `--astrbot-url` | AstrBot地址 | "http://localhost:6185" |
| `--username` | 用户名 | "Germania" |
| `--password` | 密码 | 默认密码 |
| `--chunk-size` | 分片大小 | 自动 |
| `--chunk-overlap` | 分片重叠 | 自动 |
| `--delay` | 上传间隔(秒) | 1.0 |
| `--record-file` | 上传记录文件 | "upload_record.json" |

## 📈 使用场景

### 1. 首次批量上传
```bash
# 上传所有文件到新知识库
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --kb-name "完整数据库"
```

### 2. 增量上传
```bash
# 添加新文件到现有知识库
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source\新文件" --kb-name "完整数据库"
```

### 3. 分类上传
```bash
# 按类型分别上传
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source\PDF文档" --kb-name "PDF文档库"
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source\Word文档" --kb-name "Word文档库"
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source\Excel表格" --kb-name "Excel表格库"
```

## 🔧 性能优化

### 1. 网络优化
```bash
# 减少上传间隔提高速度
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --delay 0.5

# 增加上传间隔避免服务器压力
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --delay 2.0
```

### 2. 分片优化
```bash
# 大文件使用小分片
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --chunk-size 500

# 小文件使用大分片
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --chunk-size 2000
```

## 🚨 注意事项

### 1. 前置要求
- AstrBot必须正在运行
- 知识库插件必须已安装并启用
- 必须配置至少一个Embedding提供商

### 2. 文件要求
- 文件必须可正常打开
- 避免损坏的文件
- 建议文件大小不超过100MB

### 3. 网络要求
- 稳定的网络连接
- 足够的带宽
- 避免网络中断

## 🔍 故障排除

### 常见问题

#### 1. 登录失败
```bash
# 检查AstrBot是否运行
curl http://localhost:6185/api/auth/login

# 检查用户名密码
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --username "Germania" --password "your_password"
```

#### 2. 上传失败
```bash
# 检查文件是否损坏
python -c "import fitz; fitz.open('文件路径.pdf')"

# 减小分片大小
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --chunk-size 500
```

#### 3. 网络超时
```bash
# 增加上传间隔
python batch_upload_files.py "D:\Github Doc\AstrBotLauncher\Database_Source" --delay 3.0

# 检查网络连接
ping localhost
```

## 📊 监控进度

### 1. 查看日志
```bash
# 实时查看日志
tail -f batch_upload.log

# 查看错误日志
grep "ERROR" batch_upload.log
```

### 2. 检查进度
```bash
# 查看上传记录
cat upload_record.json | jq 'keys | length'

# 查看知识库状态
curl -H "Authorization: Bearer $TOKEN" http://localhost:6185/api/plug/alkaid/kb/collections
```

## 🎯 最佳实践

### 1. 分批处理
```bash
# 按文件大小分批
find "D:\Github Doc\AstrBotLauncher\Database_Source" -name "*.pdf" -size +50M -exec mv {} large_files/ \;
find "D:\Github Doc\AstrBotLauncher\Database_Source" -name "*.pdf" -size -50M -exec mv {} small_files/ \;

# 分别处理
python batch_upload_files.py "small_files" --kb-name "小文件库"
python batch_upload_files.py "large_files" --kb-name "大文件库"
```

### 2. 定期备份
```bash
# 备份上传记录
cp upload_record.json upload_record_backup.json

# 备份日志
cp batch_upload.log batch_upload_backup.log
```

### 3. 监控资源
- 监控磁盘空间
- 监控网络带宽
- 监控AstrBot内存使用

## 🎉 完成后的使用

### 1. 在聊天中使用
```bash
/kb use 批量上传知识库    # 激活知识库
/kb 查询内容              # 查询知识库
```

### 2. 管理知识库
- 访问：http://localhost:6185
- 进入：Alkaid → 知识库
- 管理：查看、编辑、删除知识库

### 3. 优化查询
- 调整检索参数
- 优化提示词
- 监控查询效果 